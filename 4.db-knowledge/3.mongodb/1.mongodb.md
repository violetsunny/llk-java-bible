## MongoDB
BSON的数据结构，是一个半结构化数据，其灵活的文档模型和动态模式使其能够适应各种不同的数据结构需求，同时提供了强大的索引和查询功能，方便对数据进行快速检索和分析，支持事务。
一、数据库（Database）
MongoDB 中的数据库是一个逻辑容器，用于存储一组相关的集合。它类似于关系型数据库中的数据库概念。
一个 MongoDB 实例可以包含多个数据库，每个数据库都有自己独立的命名空间和权限设置。
数据库名称必须由字母、数字、下划线或连字符组成，并且不能以数字开头。同时，数据库名称区分大小写。
一些特殊的数据库名称有特定的用途，例如 “admin” 数据库用于存储管理员用户信息和权限设置，“local” 数据库用于存储本地副本集的内部数据。
二、集合（Collection）
集合是 MongoDB 中存储文档的容器，类似于关系型数据库中的表。
一个集合可以存储不同结构的文档，这意味着集合中的文档不需要具有相同的字段。
动态模式：MongoDB 的集合是无模式的，即可以在不预先定义模式的情况下插入文档。这使得 MongoDB 非常灵活，可以适应不断变化的数据结构。
高效存储：MongoDB 使用 BSON（Binary JSON）格式存储文档，这种格式比纯文本 JSON 更高效，并且支持更多的数据类型。
三、文档（Document）
文档是 MongoDB 中存储数据的基本单位，类似于关系型数据库中的行。
文档以 JSON 格式表示，由一组键值对组成。键是字段名称，值可以是各种数据类型，包括字符串、数字、日期、数组、对象等。
嵌套结构：文档可以包含嵌套的子文档，这使得 MongoDB 能够轻松表示复杂的数据结构。例如，可以在一个文档中存储一个用户的信息，包括姓名、年龄、地址等字段，而地址字段又可以是一个包含街道、城市、国家等字段的子文档。
灵活的数据类型：MongoDB 支持多种数据类型，包括基本数据类型和复杂数据类型。这使得开发者可以根据实际需求选择合适的数据类型来存储数据。

四、索引（Index）
索引是一种数据结构，用于提高 MongoDB 中数据的查询性能。它类似于关系型数据库中的索引概念。
MongoDB 支持多种类型的索引，包括单字段索引、复合索引、文本索引、地理空间索引等。
加快查询速度：通过创建合适的索引，可以大大加快查询数据的速度。索引可以帮助 MongoDB 快速定位满足查询条件的文档，而无需扫描整个集合。
支持排序和聚合操作：索引还可以用于支持排序和聚合操作。例如，如果在一个字段上创建了索引，那么可以使用该索引对集合中的文档进行排序。
五、副本集（Replica Set）
副本集是一组 MongoDB 服务器，它们共同维护相同的数据副本。副本集提供了数据的冗余和高可用性，当主节点出现故障时，副本集中的其他节点可以自动选举出一个新的主节点。
主节点（Primary）：负责处理所有的写操作，并将数据同步到副本节点。
副本节点（Secondary）：存储主节点的数据副本，并可以在主节点出现故障时提升为主节点。
仲裁节点（Arbiter）：在副本集中只参与选举过程，不存储数据。仲裁节点可以帮助副本集在奇数个节点的情况下避免出现选举僵局。
六、分片（Sharding）
分片是一种将大型数据集分布在多个 MongoDB 服务器上的技术。通过分片，可以水平扩展 MongoDB 的存储容量和查询性能。
分片集群（Sharded Cluster）：由多个分片服务器、配置服务器和路由服务器组成。
分片服务器（Shard）：存储数据的实际服务器，可以是单个 MongoDB 实例或副本集。
配置服务器（Config Server）：存储分片集群的配置信息，包括数据分布、索引等。
路由服务器（Query Router）：接收客户端的查询请求，并将请求路由到正确的分片服务器上。
七、数据类型
基本数据类型：
字符串（String）：用于存储文本数据。
数字（Number）：包括整数和浮点数。
布尔值（Boolean）：表示真或假。
日期（Date）：用于存储日期和时间。
数组（Array）：用于存储一组值。
对象（Object）：用于存储嵌套的键值对。
复杂数据类型：
对象 ID（ObjectId）：MongoDB 自动生成的唯一标识符，用于标识每个文档。
地理空间数据类型（Geospatial Data Types）：用于存储地理位置信息，支持地理空间查询。
二进制数据（Binary Data）：用于存储二进制数据，如图像、音频等。

Robo 3T 提供了对 MongoDB 和 SCRAM-SHA-256（升级的 mongo shell）的支持，是一款轻量级的 MongoDB 客户端工具。

mongodb吃内存的问题，解决办法只能通过ulimit来控制内存使用量。

## MongoDB的wriedtiger
MongoDB默认存储引擎是wriedtiger。是B树，不进行范围扫描，不排序。在每个树的节点上使用跳表实现更新缓冲。WiredTiger 缓存 B 树节点，用内存来抵消随机读写的性能问题。MongoDB 是文档型数据库，采用内聚的形式存储数据（你可以理解为在关系型数据库上增加了扩展列）。故这种数据库很少进行 join 操作，不需要范围扫描且一次访问就可以获得全部数据。而 B 树每个层级上都有数据，虽然查询性能不稳定，但总体平均性能是要好于 B+ 树的。WiredTiger 牺牲了一定的查询性能来换取空间利用率和写入性能。因为查询的时候出来读取页面数据外，还要合并跳表内的数据后才能获取最新的数据。
ObjectID分布式生成全局唯一主键。

MongoDB在3.2之前是B树，之后默认WiredTiger引擎后，便一直是B+树。B-Tree(B+ Tree to be specific)

MongoDB 适用于需要事务支持和灵活数据结构的应用场景。

一、存储结构与特点
文档存储方式：
WiredTiger 以 BSON（Binary JSON）格式存储文档。BSON 是一种二进制表示的 JSON 格式，相比纯文本的 JSON 更加紧凑和高效。这种存储方式使得 MongoDB 能够快速地读取和写入文档，提高数据库的性能。
每个文档在存储时都有一个唯一的标识符（ObjectId），方便快速定位和检索文档。
数据压缩：
WiredTiger 支持多种压缩算法，可以对数据进行压缩存储，节省磁盘空间。压缩算法包括 Snappy 和 zlib 等，可以根据实际需求选择合适的压缩方式。
压缩不仅减少了磁盘占用空间，还可以减少磁盘 I/O 操作，提高数据库的性能。
内存管理：
WiredTiger 采用了一种高效的内存管理机制，能够有效地利用内存来缓存数据。内存中的缓存可以大大提高数据的访问速度，减少磁盘 I/O 操作。
同时，WiredTiger 还可以根据系统的负载和内存使用情况自动调整缓存的大小，以达到最佳的性能。
二、事务支持
多文档事务：
WiredTiger 支持多文档事务，这意味着可以在一个事务中对多个文档进行操作，保证数据的一致性和完整性。
事务可以确保一组操作要么全部成功，要么全部失败，不会出现部分成功部分失败的情况。这对于需要保证数据一致性的应用非常重要。
隔离级别：
WiredTiger 提供了多种事务隔离级别，包括读未提交、读已提交、可重复读和串行化。不同的隔离级别可以满足不同的应用需求，同时也会对性能产生一定的影响。
例如，读未提交隔离级别允许事务读取未提交的数据，可能会导致脏读；而串行化隔离级别可以保证最高的事务隔离性，但会对性能产生较大的影响。
三、性能优势
并发控制：
WiredTiger 采用了一种先进的并发控制机制，多版本并发控制（Multiversion Concurrency Control，MVCC），允许多个客户端同时对数据库进行读写操作，而不会出现数据冲突。
MVCC当对数据库中的数据进行修改时，WiredTiger 不会直接覆盖原有的数据，而是创建一个新的版本。每个版本都有一个唯一的时间戳或版本号，用于标识其创建的顺序。读取时会确定一个快照，只读取该快照对应的版本的数据，不受其他事务的修改影响。写操作会创建新的版本，并将修改后的数据写入新的版本中。同时，WiredTiger 会维护一个版本链，记录数据的历史变化。
这种并发控制机制可以提高数据库的并发性，减少锁竞争，从而提高数据库的性能。
索引管理：
WiredTiger 对索引的管理也非常高效。它支持多种类型的索引，包括 B 树索引、哈希索引和地理空间索引等。
索引可以大大提高数据的查询速度，而 WiredTiger 的索引管理机制可以确保索引的高效性和可靠性。
四、可靠性与持久性
数据持久化：
WiredTiger 确保数据的持久性，即当数据写入磁盘后，即使系统发生故障，数据也不会丢失。
它通过预写日志（Write-Ahead Logging，WAL）和检查点（Checkpoint）机制来保证数据的持久性。预写日志记录了所有的写操作，以便在系统故障时进行恢复；检查点则定期将内存中的数据刷新到磁盘上，确保数据的持久性。
数据备份与恢复：
MongoDB 可以结合 WiredTiger 的特性进行数据备份和恢复。可以使用 MongoDB 的备份工具对数据库进行定期备份，以便在数据丢失或损坏时进行恢复。
WiredTiger 的存储结构和日志机制使得数据恢复更加快速和可靠。

WiredTiger对于B树的结构进行了调整，比如节点的可以动态扩展和收缩，精细的锁机制允许多个事务并发地访问和修改不同部分的树结构， B 树节点中的数据进行压缩。

总之，MongoDB 默认使用 WiredTiger 存储引擎，是因为它具有高效的存储结构、强大的事务支持、优秀的性能优势以及可靠的数据持久性。这些特点使得 MongoDB 能够满足各种不同应用场景的需求，成为一种广泛使用的非关系型数据库。

## MongoDB 和 Elasticsearch对比
MongoDB 和 Elasticsearch 的数据结构与性能对比：
一、数据结构对比
MongoDB：
数据库与集合：
MongoDB 以数据库为顶层容器，每个数据库可以包含多个集合。数据库类似关系型数据库中的一个独立的数据库实例，集合则类似于表。
集合中的文档可以具有不同的结构，不需要预先定义固定的模式，具有灵活性。
文档结构：
以 BSON（Binary JSON）格式存储文档，由一组键值对组成。可以包含各种数据类型，如字符串、数字、日期、数组、对象等，并且可以嵌套子文档，适合表示复杂的数据结构。

Elasticsearch：
索引与类型：
Elasticsearch 以索引为主要的数据存储单元，索引可以看作是一个逻辑上的数据库。在早期版本中，一个索引可以包含多个类型，但从较高版本开始逐渐不建议使用多类型，现在一个索引通常只对应一种类型的文档。
索引由一个或多个分片组成，每个分片是一个独立的 “小型索引”，分布在不同的节点上，实现分布式存储。
文档结构：
文档以 JSON 格式存储，与 MongoDB 类似，也是由键值对组成。但 Elasticsearch 的文档更侧重于为搜索和分析而设计，对于文本字段可以定义特定的分词器进行分词处理，以便进行全文搜索。

二、性能对比
（1）查询性能：
MongoDB：
对于复杂的多表关联查询和事务处理有较好的性能，特别是在事务要求严格的场景下表现较为稳定。
对于特定的查询场景，如基于精确匹配和范围查询，可以通过创建合适的索引来提高查询速度。但在处理大规模的文本搜索和复杂的分析查询时，性能可能不如 Elasticsearch。

Elasticsearch：
专门为搜索和分析而设计，在全文搜索方面性能卓越。能够快速处理大规模的文本数据，支持复杂的查询语法和聚合操作，可以进行实时的数据分析和报表生成。按时间范围查询性能不错，会对时间字段进行处理进行范围查询。
对于复杂的条件查询和模糊搜索，Elasticsearch 能够利用其倒排索引和分布式架构，快速返回结果。但在事务处理方面相对较弱。
（2）写入性能：
MongoDB：
写入操作相对高效，特别是对于单个文档的插入和更新操作。由于其灵活的数据结构和存储方式，可以快速地将新数据写入磁盘。
在处理高并发的写入请求时，MongoDB 可以通过配置副本集和分片来提高写入性能和可用性。

Elasticsearch：
写入性能也较高，但在写入数据时需要进行一些额外的处理，如构建索引和更新倒排索引。对于大规模的批量写入，可以通过优化配置和使用合适的工具来提高写入速度。
Elasticsearch 的写入性能在分布式环境下可能会受到网络延迟和节点故障的影响，但它具有自动故障转移和数据恢复机制，保证了数据的可靠性。
（3）可扩展性：
MongoDB：
通过分片技术可以实现水平扩展，将数据分布在多个节点上，提高存储容量和处理能力。可以根据实际需求动态地增加或减少分片数量。
支持副本集，提供数据冗余和高可用性，当主节点出现故障时，副本节点可以自动提升为主节点。

Elasticsearch：
高度可扩展的分布式搜索引擎，能够轻松处理大规模的数据。可以通过增加节点来扩展集群的存储容量和处理能力，自动进行数据的均衡分布。
具有良好的自动故障转移和恢复机制，保证了系统的高可用性。在处理大规模数据和高并发查询时，能够保持较好的性能。

总体而言，MongoDB 和 Elasticsearch 在不同的场景下各有优势。MongoDB 适用于需要事务支持和灵活数据结构的应用场景，而 Elasticsearch 则在全文搜索和数据分析方面表现出色。在选择使用哪种数据库时，需要根据具体的业务需求和性能要求进行综合考虑。
