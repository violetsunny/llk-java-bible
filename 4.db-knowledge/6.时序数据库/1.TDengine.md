## TDengine
TDengine是针对物联网的时序数据库，索引也使用了B+树的结构，是结构化数据，需要明确存储数据的定义。不过新版本错误的字段定义会跳过

（1）超级表（对应物模型结构）：
超级表是 TDengine 中用于管理一组具有相同结构的子表的概念。超级表定义了子表的共同结构，包括数据列的类型、标签列的定义等。
超级表不存储实际的数据，而是作为子表的模板，方便数据的管理和查询。例如，可以通过超级表对一组具有相同数据结构的传感器数据进行统一管理。
（2）子表（对应实际设备数据结构）：
子表是实际存储时序数据的表，每个子表对应一个数据采集点。子表继承了超级表的结构，并具有自己独特的标签值。
通过超级表和子表的结构，TDengine 可以高效地管理大量具有相似结构的数据采集点，同时方便进行数据查询和聚合操作。
（3）数据分片与分区：
TDengine 从采集点维度和时间戳维度对大规模数据进行分片（sharding）和分区（partition）。通过这种方式，将数据划分成多个数据块，便于管理和查询。在查询时，过滤条件（where 子句）能够直接定位到某个或某几个数据块，减少数据检索范围，提高查询速度。例如，对于智能电表数据，按电表设备进行分片，同时按时间范围进行分区，这样在查询特定电表在某时间段内的数据时，能快速定位到相关数据块 。
（4）高效的数据压缩：
针对时序数据的特点，采用了高效的数据压缩算法。时序数据通常具有一定的规律性和重复性，比如相邻时间点的数据变化可能不大，TDengine 利用这些特性进行压缩，大大节省了存储空间。同时，在数据读取时，能够快速解压缩，不影响查询性能。
（5）流式计算引擎：
1.数据接收与处理流程：
流式计算引擎首先接收来自数据源的数据，这些数据源可以是传感器、日志文件、消息队列等。数据以流的形式不断流入引擎。
引擎对接收到的数据进行解析和预处理，提取出关键信息，并将其转换为内部的数据格式。然后，根据预先定义的计算逻辑对数据进行实时计算。
计算结果可以立即输出给用户，或者存储在数据库中供后续查询和分析。
2.窗口机制：
为了更好地处理流数据，流式计算引擎通常采用窗口机制。窗口是对数据进行分组和聚合的一种方式，它可以根据时间、数量或其他条件将数据划分成不同的窗口。
例如，时间窗口可以将数据按照固定的时间间隔进行划分，如每一分钟、每一小时等。在每个窗口内，引擎可以对数据进行聚合计算，如求和、平均值、最大值等。
窗口机制使得流式计算引擎能够对不同时间段的数据进行有针对性的分析，满足各种业务需求。
3.增量计算：
流式计算引擎通常采用增量计算的方式，即对于新到达的数据，只需要在已有计算结果的基础上进行增量更新，而不需要重新对所有数据进行计算。
这种方式可以大大提高计算效率，特别是在处理大规模流数据时。例如，对于一个实时统计数据的应用，当新的数据到达时，只需要将其加入到已有统计结果中，而不需要重新对所有数据进行统计。
TDengine会进行预先计算并进行缓存，通过并行计算加快速度，这样能提高查询效率。对时间和标签加索引可以快速检索。

TDengine 的数据存储过程是先存内存再落盘到磁盘。TDengine 采用先写入内存再写入 WAL（Write-Ahead Log）文件再刷盘的方式。具体过程如下：
数据写入内存缓冲区：当数据写入 TDengine 时，会先进入内存中的缓冲区。这个缓冲区起到了临时存储数据的作用，以便后续进行批量处理或满足一定条件后再落盘。
内存数据处理与排序（可选）：在内存中，TDengine 可能会对数据进行一些处理操作，比如对于乱序数据会通过跳表结构等方式进行排序。这样可以保证数据在内存中的有序性，以便后续的操作。
数据落盘到磁盘：当内存缓冲区中的数据达到一定阈值（比如缓冲区的 1/3 已满）或者关闭数据库服务等特定条件触发时，内存中的数据会落盘到该表所属的虚拟节点（vnode）的目录下的磁盘文件中。每个虚拟节点都有独立的运行线程、内存空间和持久存储路径。
这种先存内存再落盘的方式有诸多优点，比如可以提高数据的写入性能，因为内存的读写速度远高于磁盘。同时，通过在内存中进行一些预处理操作，可以减少后续在磁盘上的数据处理成本。但也需要合理管理内存资源，避免内存不足导致的写入阻塞等问题。

索引优化：合理设置时间范围分区，建立复合标签索引，合适时间区间避免全表扫描。
update 参数设为1即可实现按时间戳主键更新记录。
TDengine 允许写入数据的时间范围是：从 now-keep 到 now+days。数据保留天数（keep），数据存储时间跨度（days）。因此，如果要写入的数据超出这个范围，就会出现超出范围的错误。

TDengine社区版在数据量增长和时间延长后，确实可能会遇到数据碎片问题，这通常是由数据行更新、表删除或数据过期等原因导致的。碎片化问题极大的降低查询性能。不支持删除表内数据。TDengine新增了SQL指令COMPACT来启动碎片重整过程，以优化性能，但是会很大的消耗IO
新版本的TD可以支持类型不匹配跳过该字段而不是报错。

## 时序数据库和ES
时序数据存储过程都是先写WAL（预写日志）文件，然后同步到内存中，再根据缓冲区大小和超时时间进行刷盘。同时许需要对数据结构进行压缩。

时序数据主要针对时间维度数据，对时间序列进行索引，优化时间序列存储和压缩。ES主要还是用于全文搜索和分析。
而像我们的服务日志，主要就是看要不要对内容进行全文检索，需要在复杂多变的内容中寻找你要的结果。如果需要这样做，那就ES，因为ES有非常好的检索性能。如果没有这样的需求，那就时序数据，时序数据对时间查找非常友好，并且有压缩功能可以减少大量日志存储空间。不过就展示界面来说ELK可能更适合日志的查看，而时序数据结合的像Grafana是对时序数据中某个数据的统计。
