## 分布式一致性的算法
Paxos -- Muti-Paxos(并发) -- Raft

所谓的 Paxos 算法，是为了解决来自客户端的值被发送到集群中的任意一点，而后集群中的所有节点为该值达成共识的一种协调算法。同时这个值伴随一个版本号，可以保证消息是有顺序的，该顺序在集群中任何一点都是一致的。
基本的 Paxos 算法非常简单，它由三个角色组成：提议者（Proposer）、接受者（Acceptor）和学习者（Learner）。
Proposer：Proposer 可以有多个，Proposer 提出议案（value）。所谓 value，可以是任何操作，比如“设置某个变量的值为 value”。不同的 Proposer 可以提出不同的 value。但对同一轮 Paxos 过程，最多只有一个 value 被批准。
Acceptor：Acceptor 有 N 个，Proposer 提出的 value 必须获得 Quorum（法定人数） 的 Acceptor 批准后才能通过。Acceptor 之间完全对等独立。
Learner：上面提到只要 Quorum 的 Accpetor 通过即可获得通过，那么 Learner 角色的目的就是把通过的确定性取值同步给其他未确定的 Acceptor。

流程：
第一阶段（准备阶段）：
提议者选择一个提案编号 n，并向大多数接受者发送准备请求（Prepare (n)）。
接受者收到准备请求后，如果编号 n 大于它已经响应过的任何准备请求的编号，那么它就回复一个承诺（Promise），承诺不再接受任何编号小于 n 的提案，并返回它已经接受过的编号最高的提案（如果有的话）。

第二阶段（接受阶段）：
如果提议者收到了大多数接受者的承诺，那么它就可以提出一个值 v，并向大多数接受者发送接受请求（Accept (n, v)）。
接受者收到接受请求后，如果编号 n 等于它在准备阶段承诺的编号，那么它就接受这个提案，并回复一个确认消息。

第三阶段（学习阶段）：
当一个提议被大多数接受者接受后，学习者可以从接受者那里学习这个被选定的值。

特点：
- 强一致性：Paxos 算法能够保证在分布式系统中最终达成一致，并且一旦达成一致，这个值就不会再改变。
- 容错性：Paxos 算法能够容忍部分节点的故障，只要大多数节点能够正常工作，算法就能够正常运行。
- 复杂性：Paxos 算法的流程比较复杂，理解和实现起来都有一定的难度。

这三个角色其实已经描述了一个值被提交的整个过程。其实基本的 Paxos 只是理论模型，因为在真实场景下，我们需要处理许多连续的值，并且这些值都是并发的。如果完全执行上面描述的过程，那性能消耗是任何生产系统都无法承受的，因此我们一般使用的是 Multi-Paxos。

## Multi-Paxos
Multi-Paxos 可以并发执行多个 Paxos 协议，它优化的重点是把 Propose（准备） 阶段进行了合并，这就引入了一个 Leader 的角色，也就是领导节点。而后读写全部由 Leader 处理，同时这里与 ZAB 类似，Leader 也有任期的概念，Leader 与其他节点之间也用心跳进行互相探活。leader可以进行多次提案就是将Paxos中完整提案过程进行并发的多次提案。

Multi-Paxos 引入了两个重要的概念：replicated log 和 state snapshot。
replicated log：值被提交后写入到日志中。这种日志结构除了提供持久化存储外，更重要的是保证了消息保存的顺序性。而 Paxos 算法的目标是保证每个节点该日志内容的强一致性。

state snapshot：由于日志结构保存了所有值，随着时间推移，日志会越来越大。故算法实现了一种状态快照，可以保存最新的日志消息。当快照生成后，我们就可以安全删除快照之前的日志了。

而 Multi-Paxos 可以并发修改日志，这也体现了“Multi”的特点。但是由于可以并发进行提案，如果集群中同时出现冲突提案解决比较复杂，同时并发的修改日志造成集群节点中日志的一致性和完整性问题会很复杂。

## Raft
Raft 可以看成是 Multi-Paxos 的改进算法，是一种主从同步选举算法，是强一致性算法。

领导者（Leader）：处理客户端请求、复制日志和管理集群

追随者（Follower）：接收来自领导者的日志复制请求  

候选人（Candidate）：当 Follower 一段时间内没有接收到来自 Leader 的消息时，会变成 Candidate 并尝试进行领导者选举。

领导者将请求作为日志条目更新，通过同步给追随者，保持日志一致。raft是大部分成功即返回。同时可以通过将日志条目解析为具体指令让追随者保持最新状态。
当领导者故障时，追随者会变成候选者进行选主。为了避免混乱，在心跳检测的超时时间是随机的，也就意味着知道领导者故障的追随者是随机的不是同时知道。那在选举的时候会有一个追随者先变成候选者向其他追随者发送票请求，并且增加自己的任期(Term)。如果投票中有多个追随者变成候选者，则会根据更高任期和更完整日志的节点为领导者。如果出现多个相同任期和相同日志条目的节点，那么会通过重新等待随机超时时间来进行新一轮的选举。直到选出新的leader。leader选出后会进行同步，候选者发现新leader后会更新自己的任期并变成追随者。

## 选举算法
bully算法，ZAB,Muti-Paxos,Raft

ZAB 来源于主备复制场景，就是我们之前介绍的复制技术；而共识算法是状态机复制系统。ZAB 可以实现严格的线性一致性。而 Multi-Paxos 由于只是并发写，所以也没有所谓的线性一致，而是一种顺序一致结构，也就是数据被提交时才能确定顺序。而不是如 ZAB 那样有 Leader 首先分配了顺序，该顺序与数据提交的先后顺序保持了一致。

## 心跳监测机制
超时机制，不急于超时的全局监测机制，间接检测，Gossip检测，阈值检测，范围随机超时

## Gossip
Gossip 协议，就像流言蜚语一样，利用一种随机、带有传染性的方式，是弱一致性算法。将信息传播到整个网络中，并在一定时间内，使得系统内的所有节点数据一致。对你来说，掌握这个协议不仅能很好地理解这种最常用的，实现最终一致性的算法，也能在后续工作中得心应手地实现数据的最终一致性。

在一个处于有界网络的集群里，如果每个节点都随机与其他节点交换特定信息，经过足够长的时间后，集群各个节点对该份信息的认知终将收敛到一致。

Gossip协议是完全符合 BASE 原则，可以用在任何要求最终一致性的领域，比如分布式存储和注册中心。另外，它可以很方便地实现弹性集群，允许节点随时上下线，提供快捷的失败检测和动态负载均衡等。

相互通信访问确保在线，随机周期性发送 PING 消息， 防止节点假超时及状态过期，具有去中心化和扩展性特点。
